version: '3.8'
services:
  # 1. Database Service (MySQL)
  db:
    image: mysql:8.0
    container_name: filmshoot-db
    restart: always
    environment:
      # These must match the credentials Prisma will use
      MYSQL_ROOT_PASSWORD: my-secret-root-password 
      MYSQL_DATABASE: mydb
      MYSQL_USER: username
      MYSQL_PASSWORD: password
    ports:
      # Maps host port 3306 to container port 3306 (Optional, for local access)
      - "3306:3306" 
    volumes:
      # Ensures data persists even if the container is stopped/removed
      - mysql_data:/var/lib/mysql

  # 2. Backend Service (Uses the ./backend/Dockerfile)
  backend:
    build: 
      context: ./backend 
    ports:
      - "4000:4000"
    environment:
      # Crucial: The host must be the Docker service name 'db', NOT 'localhost'
      # The credentials must match what you set for the 'db' service (username, password, mydb)
      DATABASE_URL: mysql://username:password@db:3306/mydb
    depends_on:
      - db # Depends on 'db', NOT 'mysql-db'
    volumes:
      - ./backend:/app

  # 3. Frontend Service (Uses the ./frontend/Dockerfile)
  frontend:
    build: 
      context: ./frontend 
    ports:
      - "3000:80" 
    depends_on:
      - backend

# Define the volume outside of the services block
volumes:
  mysql_data: